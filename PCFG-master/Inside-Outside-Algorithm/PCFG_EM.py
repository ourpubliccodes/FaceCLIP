__author__ = 'zhouyang'
import random
from collections import defaultdict

import numpy as np

from Expected_count import EX_COUNT


class PCFG_EM:
    def __init__(self, pcfg_file, CFG, PP, attribute_file, n=5):
        # self.sentences = self.read_train_data(pcfg_file)
        # self.train_num = len(self.sentences)
        self.pp = PP  # pcfg
        self.cfg = CFG
        self.q = self.init_q()
        self.attribute_anno, self.attribute = self.read_attribute_data(attribute_file)
        self.n = n

    def read_train_data(self,file_name):
        sentences = []
        with open(file_name) as f:
            for line in f.readlines():
                if len(line):
                    sentences.append(line.strip())
        return sentences

    def read_attribute_data(self, file_name):
        import xlrd
        attributes_anno = []
        wb = xlrd.open_workbook(file_name)
        sh = wb.sheet_by_index(0)
        attributes = sh.row_values(0)
        listx = [26542, 20790, 19340, 9169, 13855, 12376, 17857, 25250, 15792, 19598, 23348, 492, 24230, 4517, 27848, 33310, 27270, 2820, 31923, 13269, 25066, 20464, 3460, 21314, 1442, 15790, 17249, 13799, 20600, 17461, 15289, 32633, 6804, 7482, 7538, 13264, 19448, 18414, 24667, 26042, 15138, 5117, 11935, 15656, 16529, 9076, 10403, 10894, 18537, 10193, 881, 4230, 5656, 23602, 3621, 4425, 20025, 19729, 26197, 31208, 32287, 32082, 32173, 33730, 3529, 31805, 5900, 28963, 33063, 33320, 32244, 27125, 22302, 33414, 890, 28881, 21800, 11393, 33060, 5330, 891, 24383, 33624, 12770, 6669, 31861, 15996, 25844, 3277, 14545, 18185, 31046, 4340, 8564, 33793, 30383, 32294, 31308, 4941, 20502, 8317, 20109, 20116, 32026, 2063, 2093, 3064, 8938, 16021, 7565, 552, 22660, 21245, 20899, 4553, 7348, 1429, 14536, 3715, 16318, 31340, 31664, 19676, 32103, 7792, 13648, 32967, 20795, 24099, 5161, 27313, 31879, 15992, 1367, 3994, 4673, 13243, 4513, 30965, 31801, 4014, 3604, 33315, 26198, 22408, 15822, 17245, 11932, 20183, 17354, 33049, 20445, 33215, 21212, 21571, 1480, 4115, 23725, 30227, 28223, 7044, 18028, 30106, 25254, 4161, 6909, 31992, 28953, 32412, 1145, 31328, 31786, 26425, 33089, 27198, 7604, 33430, 33778, 20270, 32637, 27273, 13969, 990, 16029, 1633, 32761, 30097, 9791, 31998, 20996, 4477, 15685, 32279, 26433, 32407, 9042, 23123, 33, 29755, 15102, 1106, 14064, 23619, 33358, 13148, 13431, 18896, 30644, 219, 28688, 4047, 644, 2195, 3920, 29620, 4281, 7154, 31402, 32310, 12618, 685, 23042, 1498, 3886, 7454, 33779, 18341, 27126, 23018, 9681, 17944, 2951, 4714, 2256, 21975, 24511, 10412, 33736, 1137, 32411, 23019, 26131, 2198, 10539, 20892, 22511, 4321, 24556, 30261, 3298, 14862, 3010, 17067, 23107, 29915, 27798, 24487, 5599, 3261, 22754, 202, 3289, 32825, 16112, 17350, 17095, 26294, 14771, 18294, 17689, 24756, 10613, 22284, 3647, 4184, 19600, 33618, 5258, 22346, 26885, 19274, 19639, 23490, 32364, 5327, 3772, 30073, 24356, 31507, 7577, 33069, 1801, 10033, 18362, 32166, 7033, 32225, 9418, 2512, 20443, 15696, 26185, 33743, 131, 20239, 26607, 13358, 20576, 1566, 32446, 18295, 30987, 17054, 28007, 33057, 13796, 31878, 18644, 26608, 16714, 27583, 7819, 21069, 7951, 20087, 1603, 32529, 27826, 32516, 33375, 30683, 33235, 27163, 10846, 19811, 3569, 33553, 21120, 1058, 17024, 20721, 5550, 12256, 20950, 32062, 22320, 51, 3881, 20676, 29702, 10945, 27140, 30225, 18910, 1681, 8278, 32689, 4459, 20579, 33694, 29561, 31136, 28071, 5236, 17107, 32500, 6819, 805, 16636, 1816, 20869, 30334, 19573, 12028, 30279, 29472, 15318, 15654, 18636, 20032, 28043, 18708, 29810, 18691, 23087, 4548, 22008, 2942, 18671, 33230, 3205, 30405, 33068, 15148, 21528, 25084, 3653, 7602, 22851, 17284, 28665, 20973, 2605, 32238, 31538, 26883, 15945, 17764, 31587, 20817, 31304, 10900, 607, 11081, 2208, 23559, 12922, 30677, 3230, 80, 28902, 16211, 22248, 609, 7386, 15855, 25204, 33279, 14251, 24727, 18055, 23452, 31541, 13430, 5734, 3521, 4550, 15125, 238, 3092, 1329, 4519, 28217, 22404, 1450, 3616, 31913, 16815, 2132, 32837, 2203, 25104, 12129, 1179, 2295, 4922, 31074, 9941, 28068, 20364, 28164, 11962, 32720, 24627, 1605, 17321, 30964, 1860, 5182, 2829, 17666, 26976, 33693, 15968, 24985, 71, 4366, 23004, 22563, 4613, 4980, 1511, 8074, 23618, 32102, 30690, 19354, 997, 8427, 14401, 5606, 27305, 31411, 19489, 18914, 2547, 24700, 25110, 22354, 20066, 31375, 33181, 4292, 15319, 4499, 745, 15998, 20471, 32537, 577, 4168, 4194, 16366, 20751, 9439, 25632, 20932, 17925, 3266, 2185, 24903, 713, 30093, 21193, 27584, 18278, 31806, 26866, 18699, 10727, 2933, 23401, 31243, 7232, 2271, 27979, 563, 1352, 18293, 16944, 32620, 31143, 33748, 32521, 1827, 8824, 9227, 5155, 6773, 1979, 6647, 27423, 13439, 31999, 20706, 15617, 5340, 3078, 17759, 21732, 31236, 20971, 26614, 28705, 15348, 20132, 4163, 29890, 6010, 16634, 2604, 24052, 5850, 30446, 4280, 31870, 14352, 20507, 20022, 18603, 25243, 10544, 15431, 15053, 30062, 17532, 29520, 12248, 6312, 31975, 24909, 16536, 10824, 11456, 33071, 32236, 28257, 29336, 2413, 1774, 10637, 22534, 16027, 15722, 16230, 9921, 31947, 27776, 6977, 32192, 18656, 20589, 16097, 11566, 28835, 23489, 7445, 10897, 968, 31857, 29318, 17905, 25395, 16166, 264, 1094, 692, 27948, 6395, 17420, 10351, 21362, 23366, 32281, 27473, 4268, 32538, 24038, 13142, 28440, 22689, 2238, 30469, 32760, 18851, 31407, 17174, 29759, 22120, 33762, 20937, 9199, 1129, 16762, 30799, 31716, 9208, 27934, 280, 32190, 5816, 10288, 30365, 14250, 2117, 2178, 27491, 3917, 20759, 33729, 3507, 23265, 2025, 3898, 25860, 33299, 3893, 7452, 3153, 16467, 31277, 26569, 2361, 5844, 16806, 29228, 25374, 20772, 20269, 21703, 13395, 23085, 19127, 17565, 21907, 4956, 3220, 32676, 3629, 20531, 32267, 24566, 20463, 26547, 1664, 22243, 22546, 3783, 21216, 20928, 18192, 30870, 31345, 11699, 19681, 14456, 17584, 27115, 23412, 15686, 5153, 19279, 33792, 29956, 4034, 10553, 25857, 25082, 13724, 31583, 19733, 23945, 3327, 18626, 3923, 14080, 30951, 20741, 33797, 20927, 33051, 24042, 14484, 3614, 4710, 20860, 2155, 23554, 33814, 3744, 11237, 31784, 22771, 17755, 16195, 31741, 9160, 32040, 31961, 19422, 19313, 18274, 7326, 1699, 7469, 14444, 11971, 3117, 4127, 32177, 1266, 2419, 26044, 20391, 4077, 21992, 30558, 799, 20313, 421, 3061, 18462, 31299, 7834, 31830, 5005, 30158, 20853, 18572, 2875, 13529, 3991, 13357, 16632, 18670, 4271, 23581, 24572, 13147, 30840, 16221, 12845, 30876, 20085, 30796, 16968, 791, 19744, 27528, 26564, 27192, 23680, 28316, 31978, 7919, 18021, 27855, 13085, 13965, 24141, 14408, 21171, 21270, 33061, 5652, 18409, 20494, 32863, 22852, 31576, 18024, 33399, 4891, 25538, 28215, 31783, 15789, 11387, 4125, 28024, 3776, 31431, 26319, 10695, 12070, 27706, 9943, 3001, 12801, 17835, 10154, 18134, 11302, 31366, 24276, 29631, 13867, 15986, 30944, 7922, 25487, 3591, 29577, 7209, 15787, 10352, 21481, 30166, 4272, 31475, 7261, 13444, 32031, 16427, 3409, 4668, 20955, 30081, 1049, 2561, 14039, 5372, 20469, 31464, 13683, 2423, 26060, 2285, 13874, 18733, 32012, 24442, 27219, 7489, 25187, 4072, 9075, 13423, 28625, 21708, 17787, 20258, 4524, 16673, 15942, 26069, 32433, 2799, 15370, 31463, 26833, 33790, 20726, 2921, 2233, 26195, 2919, 28496, 6530, 15430, 17727, 24428, 104, 2981, 32386, 15111, 26582, 18614, 20701, 29824, 7832, 33073, 2362, 3750, 32046, 3384, 26558, 18049, 1267, 22802, 21653, 31313, 1014, 13806, 32151, 18657, 4544, 16988, 16951, 17098, 3965, 24075, 24301, 24199, 21196, 28018, 23478, 33794, 14022, 8206, 18149, 2299, 33104, 31882, 10693, 15093, 17104, 18701, 21731, 15740, 21728, 2874, 24602, 23975, 24473, 832, 2743, 671, 32899, 1983, 21233, 28143, 4637, 28925, 26797, 20332, 7186, 21403, 7706, 26495, 20777, 22435, 24092, 3089, 1090, 21277, 13558, 3148, 32574, 4557, 9819, 31272, 32067, 8616, 21068, 18772, 7001, 21273, 17077, 27396, 6893, 4333, 31506, 13202, 17088, 4228, 6899, 17111, 20286, 11213, 30189, 33749, 33767, 22426, 22257, 3995, 25711, 31980, 33769, 29110, 2920, 3218, 26970, 26834, 16964, 1851, 17097, 13433, 13135, 12711, 13104, 3157, 8654, 2859, 18323, 29371, 3143, 19920, 27067, 31314, 28128, 20182, 5459, 4285, 3763, 3321, 18102, 7189, 26232, 8100, 20908, 20014, 25203, 30542, 13021, 18953, 1066, 16259, 13201, 33555, 30730, 12557, 18153, 15456, 32044, 20365, 4323, 27595, 32171, 10758, 27214, 24630, 2915, 32724, 3509, 29974, 18236, 23422, 17550, 21113, 22641, 15166, 27690, 27127, 33741, 11996, 3889, 26717, 4035, 4997, 17779, 20408, 18714, 15588, 15459, 9349, 4580, 29926, 15060, 25684, 32048, 3626, 23146, 4146, 19974, 3726, 32824, 32931, 13189, 28130, 3803, 11324, 19170, 22370, 23294, 25680, 3330, 31383, 17258, 3293, 10172, 20887, 26988, 12141, 33306, 29722, 17071, 32586, 31902, 26993, 10774, 16733, 27301, 26765, 9245, 20255, 1638, 29683, 20639, 17185, 7655, 33771, 3429, 18070, 14423, 2968, 25007, 19331, 13916, 16805, 28884, 29170, 16774, 6566, 934, 17962, 31120, 13101, 2613, 18751, 29596, 18864, 10121, 26810, 30903, 17874, 19762, 2148, 14109, 28689, 9867, 1408, 31691, 20118, 16889, 32908, 15146, 30414, 33630, 20238, 2072, 23359, 12889, 18005, 32174, 4117, 3775, 30275, 11121, 30674, 2814, 7851, 21777, 14225, 4972, 5158, 3207, 3140, 9923, 4279, 9259, 18566, 19799, 14190, 21004, 30893, 33064, 22465, 22112, 32049, 32122, 31940, 28656, 8185, 27673, 31853, 15192, 27998, 32679, 14377, 32902, 19917, 14391, 3883, 33070, 21235, 1374, 31397, 6848, 4482, 32909, 2262, 18197, 5180, 24900, 13297, 32320, 31842, 19043, 26725, 22005, 9812, 29154, 31221, 1357, 18476, 13108, 116, 30272, 12362, 17643, 5679, 1596, 31259, 26971, 28874, 1539, 10691, 32947, 31893, 32791, 2253, 2813, 16731, 33318, 25344, 14029, 12495, 32358, 841, 2354, 30904, 259, 1115, 14578, 28094, 3773, 33222, 21123, 3370, 5773, 33272, 30837, 17478, 22854, 15416, 31932, 6916, 31392, 2027, 27216, 3617, 27770, 1667, 5454, 20659, 14763, 26563, 23807, 3299, 4530, 4738, 33043, 15243, 29831, 17348, 32052, 3031, 33800, 27646, 4348, 9473, 32112, 31455, 13479, 23003, 22214, 24539, 5071, 9784, 31693, 24807, 32925, 18997, 29302, 1208, 16501, 14839, 33754, 21302, 33079, 8859, 31917, 7417, 658, 19958, 28044, 20820, 3526, 31951, 31024, 14137, 11813, 24325, 27217, 31840, 2956, 21522, 47, 16851, 13561, 21630, 22980, 29486, 20357, 972, 4868, 30610, 26815, 27293, 12608, 31300, 27705, 154, 14945, 12201, 30734, 17750, 8306, 13129, 17191, 17395, 20125, 27694, 23382, 4664, 12860, 33772, 4743, 20140, 20462, 27582, 4267, 10676, 18261, 32706, 20005, 27139, 14709, 16426, 22088, 22701, 25249, 25385, 33335, 4233, 27195, 25834, 3959, 2970, 3657, 31672, 3781, 9137, 20865, 11199, 13391, 7583, 27601, 20157, 18790, 29843, 25613, 14608, 7331, 3859, 1919, 30226, 6177, 31140, 21881, 33796, 10390, 32297, 4424, 20739, 29791, 3204, 3979, 26292, 22486, 28116, 724, 2671, 19067, 4607, 24569, 23533, 1282, 25013, 26895, 28742, 4213, 27911, 6078, 28026, 24250, 11596, 16900, 27460, 26982, 16561, 9002, 15898, 653, 29590, 16347, 17753, 30390, 3600, 33275, 30263, 3687, 29786, 31700, 26820, 283, 14499, 20588, 1941, 3035, 30214, 26869, 3852, 7424, 32230, 12798, 2823, 26122, 27558, 2809, 2552, 6827, 28038, 33819, 28629, 18713, 13106, 4711, 28246, 32497, 33798, 32496, 27085, 33047, 3080, 9412, 4705, 18201, 14175, 20877, 17851, 2985, 26777, 28871, 13098, 6600, 13183, 17762, 513, 29715, 30109, 3897, 4661, 26249, 32072, 532, 33282, 28442, 22729, 33742, 3814, 4888, 32988, 15164, 13123, 3656, 20137, 17247, 17392, 1059, 16869, 12101, 30546, 32399, 17772, 33276, 23867, 32445, 13114, 3285, 31428, 13464, 18897, 31873, 3297, 29306, 4134, 23851, 15582, 22232, 203, 7788, 13076, 20316, 4667, 11211, 25634, 30862, 3774, 2815, 11584, 26074, 28640, 4133, 18446, 2788, 14719, 29653, 31753, 23568, 33535, 33327, 4335, 18392, 31482, 29569, 18290, 32493, 3209, 22251, 20050, 10749, 6120, 27331, 16655, 6883, 12278, 32505, 13268, 4447, 13624, 13117, 12865, 2151, 18099, 23030, 31251, 17662, 3477, 11705, 3291, 31311, 15478, 19760, 21240, 22329, 13003, 3124, 16299, 1583, 14664, 4455, 5356, 3044, 30698, 18282, 5105, 3868, 18755, 13102, 31988, 184, 3390, 18249, 4586, 15932, 28614, 3122, 21042, 2279, 20099, 29207, 3240, 5024, 31495, 33760, 33195, 13563, 24050, 8471, 32330, 23057, 25897, 21082, 19201, 3779, 23384, 29805, 24707, 24545, 6835, 33200, 13176, 27655, 31368, 33533, 3254, 31443, 20021, 31578, 14644, 21788, 29785, 27234, 12632, 33048, 28799, 2099, 20822, 33786, 33237, 30585, 4928, 30578, 10874, 3615, 3088, 32300, 33807, 32079, 23608, 20872, 26580, 618, 26781, 31767, 98, 4465, 30447, 15419, 5138, 1070, 33707, 20366, 10666, 10457, 4324, 13133, 33364, 32161, 1813, 10226, 21612, 30702, 14633, 20071, 15818, 21134, 3159, 1967, 13178, 30782, 927, 875, 16523, 530, 21977, 3368, 4286, 30080, 4849, 3610, 20383, 2316, 22060, 26906, 22937, 8473, 1657, 3017, 26190, 17182, 1270, 2189, 16491, 2944, 33221, 11002, 20242, 1075, 31986, 17966, 30551, 19770, 24065, 20026, 2160, 4185, 21757, 17181, 13510, 32045, 20041, 14605, 29627, 1277, 160, 26248, 3422, 13842, 4466, 2320, 26001, 7772, 15151, 29446, 25744, 19702, 24417, 22277, 17875, 18740, 32097, 26393, 15929, 3863, 458, 228, 30418, 3238, 3437, 12325, 20876, 31150, 25636, 32958, 30534, 31373, 20684, 1956, 20917, 3812, 26629, 18865, 1877, 10330, 437, 33065, 8444, 31087, 18976, 20516, 33294, 19237, 14524, 23782, 3113, 31845, 33734, 33820, 12351, 13610, 30082, 14510, 25737, 839, 30877, 1595, 27835, 1152, 4666, 21078, 4923, 4763, 3533, 12815, 4410, 29473, 32499, 31226, 13282, 3412, 522, 20352, 2471, 1079, 25681, 33622, 32436, 23299, 17481, 20590, 24204, 3986, 33308, 26848, 3785, 20623, 4865, 15952, 8793, 1573, 26199, 4473, 17498, 16171, 15251, 33780, 31417, 15944, 1540, 31727, 21707, 32589, 25845, 31908, 5797, 17469, 3714, 16726, 3997, 26572, 14088, 16721, 15312, 31309, 28585, 31936, 9433, 29387, 10447, 31763, 20219, 25008, 17194, 20696, 23158, 13342, 31542, 13115, 17884, 33775, 676, 2908, 15435, 19789, 14971, 33351, 5018, 27514, 16041, 16913, 18606, 26612, 2621, 11037, 13263, 33058, 95, 31884, 33732, 23491, 30554, 33201, 22133, 32545, 18745, 26728, 18269, 29891, 4059, 20898, 2643, 3551, 33788, 16790, 4734, 2931, 32194, 32635, 22256, 14487, 30678, 22638, 14248, 16737, 26475, 4041, 3132, 29239, 11661, 20542, 15997, 2963, 21825, 33081, 24507, 4930, 1836, 23872, 13270, 3079, 18696, 16198, 14099, 4032, 21632, 58, 12612, 14339, 27719, 7450, 16577, 19833, 9900, 27893, 23179, 31752, 33346, 22770, 25650, 27405, 1202, 18689, 15, 31555, 1530, 28052, 17984, 16157, 5165, 24924, 30886, 32120, 5840, 7682, 33759, 20432, 3160, 21228, 33815, 29720, 31264, 33072, 19673, 31835, 3473, 24181, 4193, 16992, 31257, 20060, 26718, 23572, 33218, 30892, 31667, 18754, 33770, 19665, 20036, 27915, 377, 3916, 23132, 6563, 14670, 2324, 5486, 21903, 14507, 10476, 33149, 13977, 22664, 11557, 13266, 28236, 14555, 29900, 15100, 9783, 28286, 27132, 4669, 20466, 32882, 2862, 30044, 26731, 14963, 3083, 18542, 16520, 3547, 9168, 18465, 31378, 7974, 3531, 3935, 29309, 7350, 3066, 9321, 25720, 4144, 28084, 1431, 20761, 33441, 4116, 23472, 20335, 1365, 29697, 11550, 17332, 27839, 1786, 25060, 26786, 32181, 29121, 26760, 14060, 25828, 3450, 12604, 27454, 30760, 853, 14783, 4767, 33297, 31381, 15391, 17090, 4634, 18845, 14059, 22212, 18463, 31721, 13457, 11912, 16950, 15641, 30635, 3416, 3662, 2162, 33764, 2166, 16701, 32271, 29092, 2946, 8393, 20492, 24863, 9853, 3918, 3786, 2950, 26538, 29369, 3720, 30538, 18482, 23346, 16066, 20505, 19943, 524, 31973, 20011, 25778, 20035, 21967, 9471, 25097, 26340, 21700, 17637, 31066, 31945, 4645, 20645, 629, 8523, 4582, 32313, 20401, 31509, 32375, 25271, 33824, 16794, 10732, 31364, 3802, 28512, 27872, 2168, 1089, 13165, 18095, 32272, 23943, 20773, 13254, 6472, 20875, 3213, 21024, 111, 15154, 26587, 25147, 13160, 13666, 1552, 1385, 48, 9371, 4458, 17658, 27149, 27296, 30282, 13403, 31051, 32344, 14050, 7781, 31061, 20862, 33245, 17889, 18051, 18376, 1584, 7716, 33066, 22612, 25015, 1487, 30113, 31387, 32692, 31047, 129, 7585, 14283, 29880, 20324, 26554, 23860, 29609, 5349, 28437, 16354, 1023, 31408, 22340, 30844, 23321, 3264, 19460, 32625, 31626, 31258, 14040, 4143, 25816, 27037, 22995, 661, 28302, 10925, 18758, 22985, 4776, 32343, 33305, 26733, 13829, 22389, 16231, 1743, 22623, 7444, 4470, 32365, 13175, 3075, 33812, 28540, 32260, 3796, 23067, 31863, 15846, 31316, 26698, 4337, 19803, 26167, 30961, 1881, 32226, 13234, 18418, 30605, 13786, 19734, 31249, 2209, 12781, 25326, 16984, 16481, 4855, 7473, 16335, 32547, 15284, 23771, 30684, 33236, 29717, 536, 486, 9452, 31885, 10606, 14156, 26359, 13833, 2772, 30229, 31419, 6648, 29895, 23667, 32443, 1412, 20314, 21735, 20386, 33781, 1497, 15260, 33444, 18718, 30182, 20999, 1209, 26099, 33082, 589, 30307, 29965, 24015, 27475, 32119, 2399, 15422, 4441, 28414, 23908, 31064, 28597, 20500, 3663, 4217, 21768, 23817, 32185, 619, 17563, 28590, 31838, 2015, 4428, 28163, 13679, 20660, 2472, 20459, 3895, 12853, 12850, 32039, 10517, 9186, 16793, 18318, 18969, 24170, 32338, 27182, 33331, 2082, 3195, 18964, 33768, 20209, 17037, 28039, 18612, 2383, 13112, 12459, 15447, 8947, 3288, 13068, 33777, 30381, 27243, 29889, 28153, 24824, 17250, 1488, 23861, 4082, 27620, 32666, 26922, 6000, 33198, 9902, 31680, 26015, 3246, 14916, 4261, 24360, 16956, 32361, 19855, 4351, 30177, 33774, 17161, 11390, 18711, 2989, 22252, 32535, 10755, 19742, 9431, 19280, 6026, 20406, 33818, 26741, 30519, 5259, 24104, 2037, 1144, 17335, 32165, 32690, 10748, 23646, 16867, 15751, 3268, 26257, 29004, 28172, 16703, 18343, 13866, 4062, 4120, 13306, 30020, 1256, 16464, 11517, 32274, 28579, 18880, 33647, 9330, 29188, 15414, 31421, 8498, 23342, 3105, 1501, 13067, 18342, 5398, 17251, 13225, 6889, 3810, 12567, 27340, 27935, 28484, 28168, 31082, 6243, 18299, 2478, 20606, 26115, 3876, 23997, 3097, 31301, 1918, 723, 33809, 31995, 27131, 3223, 424, 16219, 8822, 33791, 1086, 16207, 4538, 9779, 33758, 27103, 9955, 17361, 33045, 15581, 16170, 7002, 2317, 31871, 13769, 6020, 6164, 31355, 12233, 4502, 13356, 4671, 28544, 15442, 28431, 18434, 15907, 5139, 22409, 23376, 21551, 4356, 1250, 20547, 30609, 29734, 13809, 18738, 32113, 32089, 32891, 4384, 836, 9066, 79, 23114, 18066, 12622, 31460, 3401, 21156, 3799, 16134, 24813, 33738, 19902, 2831, 24165, 32605, 18709, 33799, 3754, 23301, 32355, 14335, 3387, 26595, 20370, 30352, 13088, 2258, 13207, 3271, 31444, 4610, 4605, 4201, 13736, 30092, 16831, 3479, 9054, 30332, 15596, 17082, 20460, 16596, 842, 23738, 31152, 3890, 19786, 136, 22208, 30353, 22056, 4400, 24453, 12180, 10459, 1230, 27622, 3971, 33825, 27089, 32068, 12952, 24889, 22411, 13145, 31130, 1011, 13655, 31559, 1406, 29021, 16676, 15118, 1268, 12723, 13612, 33804, 31809, 5854, 16270, 30007, 6254, 4699, 27640, 4461, 7689, 30048, 32115, 16286, 20804, 28696, 23569, 17208, 13861, 1298, 15127, 20584, 24949, 26960, 13077, 28327, 7566, 19361, 33577, 20802, 15281, 7986, 18560, 30281, 11675, 26764, 5181, 16256, 11521, 3833, 385, 1107, 12733, 198, 22951, 10856, 28398, 29952, 3036, 7725, 31365, 3073, 2055, 3816, 6371, 2239, 3076, 25244, 19042, 32139, 20127, 33744, 27641, 12789, 14035, 33006, 3933, 32107, 21081, 5221, 28120, 17217, 3771, 17186, 7644, 2818, 26527, 3782, 33442, 3413, 9225, 31470, 17700, 32178, 24368, 4588, 6505, 18763, 32384, 26064, 32680, 5489, 17496, 30039, 4751, 23577, 807, 2186, 11672, 1317, 30600, 2240, 18792, 7442, 9782, 15920, 32564, 16476, 2811, 4512, 32286, 18627, 3059, 5607, 27172, 28887, 33302, 31962, 31276, 18214, 6210, 32979, 7291, 33357, 20495, 25923, 25822, 14846, 4159, 1570, 31547, 13222, 33746, 24672, 4198, 20571, 31440, 22542, 5064, 2339, 17528, 4223, 32506, 18698, 3873, 28242, 33750, 7685, 1797, 4068, 17150, 11525, 32654, 33806, 25629, 20423, 23538, 33813, 7512, 26687, 23787, 2321, 19023, 25400, 13151, 24849, 3540, 3215, 30561, 1002, 4658, 18702, 4354, 16978, 15215, 1247, 12993, 6796, 23288, 11969, 22299, 3805, 29997, 18519, 15049, 8468, 21493, 18250, 5813, 4320, 3683, 22488, 10927, 30164, 4204, 31876, 22906, 29832, 26007, 533, 982, 16743, 33787, 30523, 29778, 1273, 13700, 18260, 31184, 31054, 31843, 3256, 2274, 30814, 32060, 23816, 1713, 20847, 31267, 21288, 16824, 4299, 8977, 26352, 18684, 2272, 11835, 28675, 12804, 30313, 13191, 244, 29047, 23639, 17818, 20441, 27842, 961, 4960, 32560, 465, 17448, 4546, 11150, 18179, 2310, 2110, 17873, 13093, 3902, 32559, 4365, 24223, 6855, 28937, 17711, 32453, 734, 13744, 31866, 3252, 30371, 31607, 9596, 25985, 20263, 33093, 27490, 29508, 3236, 3815, 2940, 28803, 30672, 23274, 25277, 22236, 20089, 17822, 10650, 2987, 17849, 7688, 21899, 25852, 1184, 26745, 21673, 23407, 31692, 24870, 16597, 32695, 8441, 26756, 838, 20010, 33554, 33463, 4794, 10173, 27723, 4012, 30703, 3303, 11238, 14024, 20478, 26246, 22590, 18679, 3861, 19242, 31489, 818, 32114, 5169, 20509, 13676, 12005, 23826, 4028, 3908, 1500, 32219, 21894, 9894, 12306, 30762, 20489, 12275, 12661, 16800, 11479, 3550, 31085, 23015, 32455, 13547, 17561, 20672, 14469, 17059, 24970, 26568, 3391, 28034, 32974, 18144, 23822, 13321, 11543, 31811, 27397, 12023, 13200, 446, 32083, 2080, 31287, 19478, 18038, 28381, 26769, 8689, 28382, 4698, 20904, 12873, 20737, 18083, 18500, 16644, 25999, 32757, 28683, 33735, 18589, 3470, 9880, 631, 33559, 4069, 23131, 1538, 33823, 1426, 4760, 28304, 3456, 28905, 32813, 22141, 15381, 1631, 31391, 24338, 2935, 10308, 29881, 6232, 18859, 12469, 30118, 21747, 31895, 21253, 3993, 31728, 20444, 20272, 24024, 19271, 24491, 14573, 13152, 32638, 33731, 17002, 30871, 33737, 30322, 26987, 18947, 702, 24734, 18915, 23792, 10531, 19941, 18995, 21497, 21577, 17621, 30452, 18009, 2234, 31358, 20638, 1393, 21924, 17026, 11901, 4606, 3162, 12751, 16954, 28478, 970, 31606, 31987, 27289, 24515, 15188, 15368, 18248, 27975, 6041, 24163, 3930, 30037, 30571, 18834, 12907, 25649, 33145, 32188, 21259, 22032, 24036, 7087, 4771, 4042, 7319, 16344, 9892, 4406, 31399, 15186, 20067, 12741, 26798, 3439, 33080, 26522, 16147, 11624, 32842, 14565, 14920, 33756, 20510, 8181, 27556, 21405, 5598, 32366, 490, 3760, 4731, 26259, 24119, 16151, 23488, 30453, 27337, 6231, 14794, 14954, 20669, 17743, 15875, 7672, 17022, 29570, 17827, 2749, 27902, 28883, 33365, 33180, 958, 3414, 24096, 31388, 26703, 9215, 4676, 3919, 4191, 13111, 5561, 8216, 20627, 3874, 15352, 14513, 9281, 20824, 2648, 24289, 30010, 31237, 5595, 31709, 24620, 16865, 17311, 15715, 16840, 18308, 11856, 27277, 7569, 22155, 20420, 16352, 10795, 30615, 18562, 9061, 32632, 2184, 14594, 19402, 20534, 30601, 5990, 20051, 2068, 32614, 13143, 18317, 3966, 18999, 32311, 21541, 4697, 29820, 29169, 33506, 20652, 16763, 14582, 4543, 3856, 26027, 13193, 4369, 6014, 3640, 4619, 30524, 1084, 31556, 14559, 31404, 3307, 32196, 7250, 32621, 19688, 2646, 4414, 1554, 21591, 32200, 7993, 31837, 16969, 3098, 7557, 3973, 33782, 4076, 21511, 31100, 12006, 33353, 4924, 1491, 33044, 28462, 23089, 24626, 1942, 1469, 26535, 27299, 18457, 25227, 31901, 29384, 2036, 20679, 9811, 30356, 31319, 14236, 28944, 26867, 18023, 2821, 7259, 18553, 22583, 12551, 13795, 28320, 24780, 2248, 21608, 33753, 10817, 27264, 3216, 2247, 33757, 14438, 31229, 28403, 27949, 29736, 14000, 32663, 2943, 7879, 17089, 4434, 14542, 30526, 30083, 31453, 32708, 17821, 33805, 16611, 17058, 7807, 977, 32232, 18396, 29528, 1118, 1099, 13213, 1601, 7030, 32356, 2871, 29037, 27794, 33314, 30001, 20942, 27206, 33811, 3229, 31256, 32118, 18006, 4826, 4269, 28697, 17598, 14467, 26394, 33445, 20756, 27251, 13081, 7406, 13620, 33393, 29959, 3245, 2932, 12898, 1812, 26727, 28993, 27370, 824, 31374, 28369, 32325, 10624, 26643, 25065, 3872, 32688, 5456, 28399, 22881, 23905, 23652, 33067, 33766, 31971, 980, 33765, 4602, 31818, 20833, 4772, 11475, 24730, 4436, 13100, 14661, 13693, 26846, 1682, 1652, 5341, 20285, 31896, 32532, 30665, 19923, 3276, 31240, 4375, 8650, 6212, 12886, 20245, 26310, 15267, 29038, 5620, 18725, 30976, 18662, 19125, 11826, 5302, 30063, 1251, 1610, 15806, 4151, 14558, 17131, 22476, 29682, 19163, 5782, 33046, 13493, 19790, 15673, 30394, 20298, 18315, 17096, 33274, 13688, 29310, 20641, 8302, 18474, 32104, 29467, 3085, 7375, 15223, 16855, 31804, 17215, 5151, 9893, 24439, 18817, 32020, 11952, 6833, 2619, 33339, 3984, 7966, 7612, 31524, 3644, 20092, 13435, 28567, 33761, 27827, 18381, 4131, 15248, 18109, 3000, 28138, 1690, 20819, 1817, 27111, 17610, 13789, 5223, 14572, 32827, 32342, 18685, 22206, 3800, 23135, 1302, 30297, 9044, 29438, 8467, 3757, 28678, 22244, 30556, 25294, 31953, 14500, 26671, 5339, 32261, 17977, 10356, 13241, 5089, 17715, 4037, 1625, 32557, 26808, 3892, 3791, 3981, 28435, 7027, 33284, 31478, 16271, 33261, 4967, 32096, 3888, 17295, 1109, 3034, 24401, 19439, 26028, 26152, 17669, 18075, 31841, 1073, 3793, 32570, 29251, 786, 32527, 22593, 2346, 12113, 24858, 1187, 7422, 24350, 22367, 2714, 690, 24056, 20857, 32360, 23901, 32789, 4735, 28856, 983, 2152, 15395, 21879, 17876, 32729, 1413, 16932, 2828, 26990, 14371, 8349, 4467, 1015, 2308, 32464, 20159, 25301, 20866, 18175, 30059, 6922, 29014, 33084, 15139, 119, 5040, 3525, 33803, 6179, 32303, 2289, 23051, 29711, 11233, 10723, 19253, 30448, 8409, 33733, 3842, 97, 15913, 3924, 32111, 22402, 32969, 14205, 2464, 20778, 12638, 19468, 26964, 2410, 2312, 3201, 18497, 15349, 3613, 4408, 16665, 28017, 13170, 19110, 3225, 21040, 13271, 31213, 32699, 32846, 33303, 1459, 26802, 7428, 952, 23251, 22894, 22720, 29692, 18748, 20190, 33705, 17660, 24438, 13239, 19602, 7619, 18332, 8167, 22401, 16545, 21469, 31570, 30818, 6686, 21048, 5916, 18483, 18518, 28212, 30387, 23691, 22849, 30942, 5108, 447, 2852, 20951, 19045, 4263, 15926, 12242, 13105, 29244, 7388, 20582, 4469, 33642, 31539, 161, 12838, 25878, 17068, 11394, 11632, 33229, 32669, 20475, 31426, 19203, 31344, 688, 30848, 24563, 28269, 4845, 5943, 24709, 1545, 9197, 2873, 26954, 4494, 13120, 2286, 32519, 28718, 30699, 21688, 24373, 25597, 1471, 33059, 13818, 9363, 27903, 2986, 1675, 16558, 20654, 1375, 19015, 16526, 4542, 33179, 21111, 22126, 10465, 32362, 26258, 7560, 5183, 6678, 13524, 9347, 31348, 12918, 3642, 18154, 4451, 31409, 4579, 26358, 11050, 15653, 20956, 18985, 28603, 3854, 30233, 15110, 18618, 18735, 25973, 15535, 14988, 22669, 22498, 1916, 33076, 8980, 2642, 16718, 24203, 1371, 4439, 9270, 11851, 14004, 30952, 33330, 22746, 20885, 21338, 197, 15104, 20044, 2318, 2848, 4020, 1461, 13983, 843, 16490, 24578, 27244, 3633, 32641, 20024, 28628, 30327, 19645, 18557, 20277, 17038, 33752, 31850, 16244, 29348, 33083, 27281, 18556, 33751, 24794, 29022, 14472, 24963, 23268, 1372, 30165, 21659, 3312, 3055, 32091, 20940, 26531, 18585, 14591, 33326, 1368, 28266, 10784, 14011, 11062, 15800, 3432, 31059, 32133, 30034, 32176, 19721, 5023, 19703, 16683, 3371, 11622, 19300, 16810, 1366, 18729, 14521, 31849, 4617, 19118, 3093, 3790, 20431, 4192, 29991, 229, 30478, 20585, 11900, 19796, 3063, 12586, 32598, 16782, 27799, 4979, 24161, 32655, 24178, 17693, 32754, 18941, 17032, 4225, 4621, 33600, 30079, 13915, 10251, 14612, 26421, 30602, 14607, 19335, 3247, 11575, 4957, 3203, 1644, 28557, 25936, 14041, 4549, 550, 30162, 29928, 20318, 6641, 18468, 23545, 15300, 33776, 16525, 21044, 24291, 1440, 12403, 29571, 17504, 16000, 3820, 11463, 9096, 30285, 23537, 4293, 15335, 21846, 28500, 379, 1016, 16700, 19804, 4205, 32681, 7402, 33716, 17581, 18558, 18933, 29131, 4870, 10726, 22186, 6583, 32911, 7034, 33745, 1332, 856, 659, 29732, 15142, 16250, 17263, 28583, 23542, 30377, 20911, 16894, 2531, 21015, 17052, 23745, 29994, 14716, 31090, 6610, 17739, 11144, 2505, 15333, 20621, 31351, 1725, 26431, 29162, 3878, 33816, 23313, 12204, 27382, 4277, 15640, 30071, 21353, 28225, 28028, 27715, 10274, 5932, 18541, 32324, 2670, 31467, 10577, 2843, 24179, 3928, 21159, 29887, 19333, 13066, 21221, 16670, 3840, 19465, 5299, 26784, 21456, 15438, 14150, 29635, 24419, 31260, 23165, 19211, 31696, 12830, 3561, 12998, 30283, 18549, 3513, 2994, 1421, 11850, 32599, 22620, 7562, 4713, 31543, 21393, 18736, 25616, 16667, 14275, 33763, 9205, 4426, 20738, 6017, 27074, 25123, 11926, 14554, 11496, 16725, 24259, 3077, 1254, 30680, 3421, 15782, 26876, 32292, 32518, 7791, 17235, 11982, 17923, 24280, 24525, 22291, 14020, 29888, 5967, 1867, 23894, 9683, 18198, 14373, 2170, 30267, 31067, 4950, 16638, 32522, 3795, 18072, 20487, 19039, 19738, 18272, 1728, 5383, 81, 31083, 31967, 17859, 9858, 18540, 33054, 30114, 2008, 26819, 20065, 1217, 32316, 3126, 12072, 19911, 17895, 25124, 28667, 20850, 3150, 94, 28676, 31537, 33755, 1457, 18346, 12075, 1553, 31449, 16465, 32321, 21981, 5022, 19587, 2172, 2975, 2984, 201, 20240, 27278, 5942, 44, 32131, 28471, 23136, 25624, 6788, 9629, 13621, 2860, 20888, 17337, 16492, 30291, 23892, 9863, 23877, 18234, 1398, 21446, 967, 3278, 30866, 20814, 31379, 3447, 24948, 31015, 21748, 29567, 33391, 31802, 28622, 15455, 20935, 19236, 33227, 27359, 19717, 20012, 20300, 4363, 3242, 19682, 26715, 26436, 17025, 28361, 20682, 17083, 20467, 28633, 21509, 16995, 4665, 1968, 2059, 9944, 29727, 20504, 27153, 33795, 18973, 8483, 10364, 33789, 14625, 4612, 31856, 19885, 7387, 15307, 29605, 27451, 11234, 22591, 17932, 21965, 23888, 6698, 637, 9360, 31525, 17113, 22065, 33783, 3217, 4157, 26588, 23044, 17280, 24177, 27430, 10174, 16368, 3315, 21243, 30596, 12450, 32108, 5556, 3050, 5043, 18416, 12218, 33808, 1590, 28596, 20976, 29046, 21141, 26966, 13070, 255, 20949, 29540, 84, 4278, 31248, 33773, 17347, 18908, 14490, 1988, 26226, 10085, 18921, 19802, 33055, 18327, 31116, 7188, 9830, 7590, 3404, 30639, 16305, 587, 2351, 1574, 29797, 13410, 1895, 29712, 29766, 10333, 18429, 29176, 12681, 31960, 25000, 16874, 24374, 23655, 1362, 5136, 1698, 24773, 2649, 5742, 6908, 33354, 23600, 3797, 30096, 31039, 4113, 1835, 29581, 18271, 29270, 12832, 30786, 31262, 26887, 2137, 15870, 17061, 3294, 27650, 27559, 20565, 1883, 17377, 22230, 22413, 20526, 31393, 33420, 4848, 31795, 20938, 25832, 942, 33470, 6886, 16637, 2393, 6981, 20029, 1882, 27183, 29026, 16560, 26686, 27120, 3423, 16922, 17471, 31823, 3287, 3590, 12690, 12848, 23324, 18936, 3206, 2380, 24605, 90, 3257, 13377, 18063, 20278, 20837, 20342, 4074, 11824, 19072, 28284, 11407, 26523, 22986, 16671, 1894, 29815, 4283, 33747, 18535, 32170, 5836, 8954, 11711, 23252, 26303, 2028, 31412, 20913, 28962, 3145, 21939, 14449, 18189, 4264, 24275, 8949, 27156, 2010, 2855, 19261, 23463, 29301, 15809, 33687, 14998, 28526, 10229, 33513, 30710, 7369, 27223, 3502, 3934, 17945, 22836, 5065, 8985, 13775, 23628, 24399, 25221, 3193, 27829, 14743, 33802, 16005, 21537, 11346, 18962, 26909, 13893, 4378, 2297, 10679, 24162, 31009, 3606, 26517, 20362, 1425, 29976, 877, 26940, 11839, 16402, 1360, 29878, 24198, 216, 3410, 4511, 5699, 26617, 10745, 31380, 18778, 31883, 5485, 20346, 30682, 32369, 32056, 30568, 5301, 8368, 15794, 3938, 33661, 33464, 4290, 3665, 23505, 21987, 500, 8318, 16875, 26908, 20948, 18982, 3931, 19358, 25320, 22347, 31354, 30335, 4495, 20852, 32124, 4536, 5004, 9131, 33290, 6145, 33392, 7359, 27856, 32918, 15133, 29721, 29995, 2647, 3400, 31984, 23353, 9187, 13602, 4347, 12772, 1112, 32415, 1815, 17832, 32093, 4675, 33056, 17609, 3198, 2949, 4503, 19994, 33304, 13884, 3982, 33263, 31540, 22997, 26377, 33673, 10724, 15170, 13398, 27107, 4630, 28951, 18467, 9177, 4898, 19432, 4367, 11834, 3926, 482, 9822, 22470, 24574, 15493, 20799, 13383, 16948, 3322, 32596, 32363, 30801, 3062, 4150, 3849, 20863, 33528, 20642, 1914, 33449, 19416, 20879, 19069, 32447, 24258, 32626, 28890, 30066, 31096, 13320, 4672, 32100, 13177, 13556, 31955, 26779, 18694, 16439, 29137, 27765, 26720, 26206, 28396, 23900, 30597, 19897, 4766, 33389, 3038, 32098, 17053, 3249, 3528, 3624, 30756, 19755, 33785, 25296, 22981, 900, 31456, 23631, 21462, 545, 13237, 28837, 2205, 7372, 7383, 31717, 30869, 27863, 31452, 31418, 19898, 15373, 4229, 26948, 3882, 10395, 27760, 33152, 23717, 24313, 29458, 19583, 20709, 32783, 30673, 23742, 20781, 30157, 21706, 32076, 1402, 23820, 24120, 31864, 31377, 4197, 19999, 14909, 26873, 1485, 3419, 3741, 22124, 24925, 28634, 18990, 20103, 31214, 140, 11564, 30879, 32897, 2673, 20090, 33379, 33052, 27105, 33312, 17128, 7559, 3651, 30196, 19022, 29036, 4154, 27522, 31278, 22274, 24253, 30367, 32539, 14834, 17141, 18677, 28202, 639, 31343, 18949, 30221, 3530, 4736, 30805, 16202, 4471, 1634, 12496, 26644, 27789, 17447, 1736, 12834, 7151, 33050, 17580, 10113, 13947, 6914, 26934, 24192, 25138, 4404, 33258, 4462, 5727, 1575, 13699, 3374, 29838, 3787, 31490, 16316, 4591, 29087, 3652, 3968, 23150, 19474, 26395, 32486, 20282, 9483, 3688, 10314, 3660, 26972, 10716, 15487, 33696, 2283, 5510, 20322, 18987, 2669, 31021, 27746, 18481, 5118, 27890, 31123, 30906, 2002, 32227, 24195, 32231, 794, 15830, 18904, 33042, 26063, 32568, 7389, 27193, 20842, 31182, 4303, 20903, 29644, 20760, 33810]
        for rownum in listx:
        # for rownum in range(1, sh.nrows):
            temp = sh.row_values(rownum)
            # print(temp[0])
            attributes_anno.append(temp)
        return attributes_anno, attributes

    def init_q(self):
        q = defaultdict(float)
        # for A in self.cfg.noterminals:
        #     c = 0
        #     for (A2,w) in self.cfg.unary_rules:
        #         if A2==A:
        #             c = c + 1
        #     for (A2, B, C) in self.cfg.binary_rules:
        #         if A2==A:
        #             c = c + 1
        #     sum = 0.0
        #     for (A2,w) in self.cfg.unary_rules:
        #         if A2==A:
        #             if c == 1:
        #                 q[tuple([A,w])] = 1.0- sum
        #             else:
        #                 q[tuple([A,w])] = random.uniform(0,1.0-sum)
        #             c = c - 1
        #             sum = sum + q[tuple([A,w])]
        #     for (A2,B,C) in self.cfg.binary_rules:
        #         if A2 == A:
        #             if c == 1:
        #                 q[tuple([A,B,C])] = 1.0 - sum
        #             else:
        #                 q[tuple([A,B,C])] = random.uniform(0,1.0-sum)
        #             c = c - 1
        #             sum = sum + q[tuple([A,B,C])]
        #######
        for A in self.pp.p_noterminals:
            for (A2, w, p) in self.pp.p_unary_rules:
                if A2 == A:
                    q[tuple([A,w])] = p

            for item in self.pp.p_binary_rules:
                A2 = item[0]
                if A2 == A:
                    q[item[:-1]] = item[-1]
        return q

    def EM(self, iter_num=50):
        q = self.q
        for it in range(1,iter_num):
            print('start the',it,'th iterator')
            f = defaultdict(float)
            for (A,w) in self.cfg.unary_rules:
                f[tuple([A,w])] = 0.0
            for (A,B,C) in self.cfg.binary_rules:
                f[tuple([A,B,C])] = 0.0
            for i in range(1,self.train_num+1):
                sentence = self.sentences[i-1]
                ex_count = EX_COUNT(sentence=sentence,CFG=self.cfg,q =q)
                count = ex_count.get_count()
                for (A,w) in self.cfg.unary_rules:
                    f[tuple([A,w])] += count.get(tuple([A,w]))
                for (A,B,C) in self.cfg.binary_rules:
                    f[tuple([A,B,C])] += count.get(tuple([A,B,C]))

            for A in self.cfg.noterminals:
                sum_f = 0.0
                for (A2,w) in self.cfg.unary_rules:
                    if (A2==A):
                        sum_f += f[tuple([A,w])]
                for (A2,B,C) in self.cfg.binary_rules:
                    if (A2 == A):
                        sum_f += f[tuple([A,B,C])]

                for (A2,w) in self.cfg.unary_rules:
                    if(A2 == A and sum_f):
                        q[tuple([A,w])] = (f[tuple([A,w])] / sum_f)
                    if (A2 == A  and f[tuple([A,w])] == 0.0):
                        q[tuple([A,w])]=0.0

                for (A2,B,C) in self.cfg.binary_rules:
                    if(A2 == A and sum_f):
                        q[tuple([A,B,C])] = (f[tuple([A,B,C])] / sum_f)
                    if(A2 ==A and f[tuple([A,B,C])] == 0.0):
                        q[tuple([A,B,C])]=0.0
            print('OK')
        return q

    # def gen_sentence(self, symbol, temp_unary_rules):
    #     '''
    #     Generalize sentence from pcfg
    #     :param symbol:
    #     :return:
    #     ''' ## 需要按照每张图像给出的属性标记，选择出可以choose的属性，没有的需要临时删除掉，否则句子中会出现图像中没有的属性词
    #     tokens=[]
    #     for (A,w) in temp_unary_rules:
    #         if A == symbol:
    #             num = int(self.q.get((A,w))*1000)
    #             for i in range(num):
    #                 tokens.append(w)    # 取出来是str型的单词
    #     for item in self.cfg.binary_rules:
    #         A = item[0]
    #         if A == symbol:
    #             num = int(self.q.get(item) * 1000)
    #             for i in range(num):
    #                 tokens.append(item[1:])   # 取出来是tuple型的元组，即使元组中的元素只有一个
    #     inx = int(random.uniform(0,len(tokens)))  # 随机抽取一个索引
    #     next_symbol = tokens[inx]
    #     if isinstance(next_symbol,tuple):
    #         if len(next_symbol) == 1:
    #             return self.gen_sentence(next_symbol[0],temp_unary_rules)
    #         if len(next_symbol) == 2:
    #             return self.gen_sentence(next_symbol[0],temp_unary_rules)+' '+self.gen_sentence(next_symbol[1],temp_unary_rules)
    #         if len(next_symbol) == 5:
    #             return self.gen_sentence(next_symbol[0],temp_unary_rules)+' '\
    #                    +self.gen_sentence(next_symbol[1],temp_unary_rules)+' '\
    #                    +self.gen_sentence(next_symbol[2],temp_unary_rules)+' '\
    #                    +self.gen_sentence(next_symbol[3],temp_unary_rules)+' '\
    #                    +self.gen_sentence(next_symbol[4],temp_unary_rules)
    #     else:
    #         return next_symbol

    def gen_sentence(self, symbol):
        '''
        Generalize sentence from pcfg
        :param symbol:
        :return:
        ''' ## 需要按照每张图像给出的属性标记，选择出可以choose的属性，没有的需要临时删除掉，否则句子中会出现图像中没有的属性词
        tokens=[]
        n = 1
        flag = 0
        for (A,w) in self.temp_unary_rules:
            if A == symbol:
                num = int(self.temp_q.get((A,w))*1000)
                for i in range(num):
                    tokens.append(w)    # 取出来是str型的单词
            if (symbol=='WearAttributes' and len(tokens) > 0) \
                    or (symbol=='IsAttributes' and len(tokens) > 0) \
                    or (symbol=='HaveAttributes' and len(tokens) > 0):   # 一个句式中的属性此可以有好几个，但是整个的句式最好不要是重复的
                n = np.random.normal(loc=4.0, scale=1.0, size=1)
                n = round(n[0])
                flag = 1

        # for item in self.cfg.binary_rules:
        for item in self.temp_binary_rules:
            A = item[0]
            if A == symbol:
                num = int(self.temp_q.get(item) * 1000)
                for i in range(num):
                    tokens.append(item[1:])   # 取出来是tuple型的元组，即使元组中的元素只有一个
             # 说明现在处理的是属性词，而不是句式rule

        if n <= 0:
            if (symbol=='WearAttributes' and len(tokens) > 0) \
                    or (symbol=='IsAttributes' and len(tokens) > 0) \
                    or (symbol=='HaveAttributes' and len(tokens) > 0):   # 一个句式中的属性此可以有好几个，但是整个的句式最好不要是重复的
                n = np.random.normal(loc=4.0, scale=1.0, size=1)
                n = round(n[0])
        # print("shuchu1: ", len(tokens), n)
        inxxs = random.sample(range(0, len(tokens)), n)  # 随机抽取n个索引
        # 如果n>该属性现有的不同值，则要将索引删除一下，以免同一句子中出现重复的词
        temp = []
        temp_inxxs = []
        for k in range(0, len(inxxs)):
            if tokens[inxxs[k]] not in temp:
                temp.append(tokens[inxxs[k]])
                temp_inxxs.append(inxxs[k])
        inxxs = temp_inxxs

        if len(inxxs) == 1 and flag == 1:  # 该剧是只有一个具体属性值，说明该词是这句话的结尾，加上标点符号。
            next_symbol = tokens[inxxs[0]]+'.'
        else:
            next_symbol = tokens[inxxs[0]]
            for k in range(1, len(inxxs)):
                # next_symbol = next_symbol+', '+tokens[inxxs[k]]
                if k == len(inxxs)-1:
                    next_symbol = next_symbol + ', and ' + tokens[inxxs[k]]+'.'
                else:
                    next_symbol = next_symbol + ', ' + tokens[inxxs[k]]
        if isinstance(next_symbol,tuple):
            if len(next_symbol) == 1:
                return self.gen_sentence(next_symbol[0])
            if len(next_symbol) == 2:
                return self.gen_sentence(next_symbol[0])+' '+self.gen_sentence(next_symbol[1])
            if len(next_symbol) == 3:
                return self.gen_sentence(next_symbol[0])+' '+self.gen_sentence(next_symbol[1])+' '+\
                       self.gen_sentence(next_symbol[2])
            if len(next_symbol) == 5:
                return self.gen_sentence(next_symbol[0])+' '+self.gen_sentence(next_symbol[1])+' '\
                       +self.gen_sentence(next_symbol[2])+' '+self.gen_sentence(next_symbol[3])+' '\
                       +self.gen_sentence(next_symbol[4])
        else:
            return next_symbol